// === SmokeSystemReport.js ===
// Gera e envia PDF do Laudo de Sistema de Fumaça

async function gerarLaudoFumaca() {
  const loja = document.getElementById("emailCliente").value || "Loja não informada";
  const tecnicoResponsavel = document.getElementById("tecnicoResponsavel")?.value || "";
  const ajudanteResponsavel = document.getElementById("ajudanteResponsavel")?.value || "";
  const dataEntrega = document.getElementById("dataEntrega")?.value || new Date().toLocaleDateString();

  const itens = [];
  document.querySelectorAll(".item").forEach((div, i) => {
    const nome = div.querySelector("h3")?.innerText || `Item ${i}`;
    const obs = div.querySelector("textarea")?.value || "";
    const files = Array.from(div.querySelectorAll('input[type="file"]'))
      .flatMap(input => Array.from(input.files))
      .slice(0, 4);

    const fotos = [];
    for (const file of files) fotos.push(URL.createObjectURL(file));
    itens.push({ nome, observacao: obs, fotos });
  });

  const nAtual = parseInt(localStorage.getItem("brvNumLaudo") || "33") + 1;
  localStorage.setItem("brvNumLaudo", nAtual);
  const numero = `BRV-2025-${String(nAtual).padStart(3, "0")}`;

  const dados = {
    titulo: "Laudo Técnico – Sistema de Detecção de Fumaça",
    loja,
    tecnicoResponsavel,
    ajudanteResponsavel,
    dataEntrega,
    numero,
    itens,
  };

  const pdfBytes = await gerarPDFBrivax(dados);
  const blob = new Blob([pdfBytes], { type: "application/pdf" });
  const fileName = `Laudo_${numero}_${loja}.pdf`;
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = fileName;
  a.click();

  const assunto = `Laudo Loja ${loja} - ${dataEntrega}`;
  const corpo = `Olá, segue abaixo o PDF do laudo de entrega de serviço.\n\nQualquer dúvida estamos à disposição.\nA equipe Brivax agradece!`;
  window.open(`mailto:${document.getElementById("emailCliente").value}?subject=${encodeURIComponent(assunto)}&body=${encodeURIComponent(corpo)}`);

  const telefone = document.getElementById("telefoneCliente").value.replace(/\D/g, "");
  if (telefone) {
    const msg = `Olá! Aqui é da Brivax. Seu laudo técnico está pronto ✅\nEnviamos o PDF do laudo de entrega do serviço para conferência.`;
    window.open(`https://wa.me/55${telefone}?text=${encodeURIComponent(msg)}`, "_blank");
  }

  alert("✅ Laudo gerado e enviado com sucesso!");
}
